CREATE PROCEDURE 3th_Highest_Value

AS
BEGIN


	SELECT distinct
	ltrim(Replace(regexp_substr(ORDER_REF, '[^-]+', 1, 1),'PO',''), '0')  Order_Reference,
	to_char(TO_DATE(ORDER_DATE, 'dd-mm-YYYY','NLS_DATE_LANGUAGE = American'),'MONTH dd,YYYY') ORDER_DATE,
	UPPER(SUPPLIER_NAME) SUPPLIER_NAME,
	DISTINCT  NTH_VALUE(TO_CHAR(NVL(ORDER_TOTAL_AMOUNT,0), '99G999G999G9999', 'NLS_NUMERIC_CHARACTERS=",."'),3)) OVER (
			PARTITION BY ORDER_TOTAL_AMOUNT
			ORDER BY ORDER_TOTAL_AMOUNT DESC
			RANGE BETWEEN UNBOUNDED PRECEDING AND 
				UNBOUNDED FOLLOWING
		) ORDER_TOTAL_AMOUNT,
	ORD_STATUS.DESCRIPTION,
	LISTAGG(INVOICE_REFERENCE, ', ') WITHIN GROUP (ORDER BY INVOICE_REFERENCE) "INVOICE_REFERENCE",
	ORDER_TOTAL_AMOUNT,2) OVER (
			PARTITION BY ORDER_TOTAL_AMOUNT
			ORDER BY ORDER_TOTAL_AMOUNT ASC
			RANGE BETWEEN UNBOUNDED PRECEDING AND 
				UNBOUNDED FOLLOWING
		) AS
	FROM XXBCM_ORDER ORDER
	LEFT JOIN XXBCM_SUPPLIER SUPPLIER ON SUPPLIER.SUPPLIER_ID = ORDER.SUPPLIER_ID
	LEFT JOIN XXBCM_INVOICE INVOICE ON INVOICE.ORDER_ID =ORDER.ORDER_ID
	LEFT JOIN XXBCM_ORDER_STATUS ORD_STATUS ON ORD_STATUS.ORDER_STATUS_ID = ORDER.ORDER_STATUS
	GROUP BY ORDER_REF,ORDER_DATE,SUPPLIER_NAME,ORDER_TOTAL_AMOUNT,ORD_STATUS.DESCRIPTION;
	
END;